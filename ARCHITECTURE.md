# Tree Editor Next - アプリケーション概要とアーキテクチャ

## 概要

Tree Editor Next は、階層構造データを視覚的に編集・管理するための Web アプリケーションです。ドラッグ&ドロップ操作による直感的なインターフェースを提供し、組織図、プロジェクト構造、ナレッジベース、マインドマップなど、様々な階層データの管理に使用できます。

## 主な用途

- **組織図管理**: 企業や団体の組織構造を可視化
- **プロジェクト管理**: WBS やタスク階層の作成・管理
- **ナレッジベース**: 情報を階層的に整理・共有
- **コンテンツ構造設計**: Web サイトやアプリケーションの情報アーキテクチャ設計
- **教育コンテンツ**: カリキュラムや学習内容の構造化
- **製品カタログ**: 商品カテゴリーの階層管理

## 技術スタック

### フロントエンド

- **Next.js 15.3.3**: App Router を使用した React フレームワーク
- **React 19.1.0**: 最新の React 機能を活用
- **Tailwind CSS v4**: ユーティリティファーストの CSS フレームワーク
- **shadcn/ui**: カスタマイズ可能な UI コンポーネントライブラリ
- **SWR**: データフェッチングとキャッシング

### バックエンド

- **Hono 4.7.11**: 軽量で高速な Web フレームワーク
- **Cloudflare Workers**: エッジコンピューティング環境
- **Drizzle ORM**: TypeScript 対応の ORM

### データストレージ

- **Cloudflare D1**: SQLite ベースのサーバーレスデータベース
- **Cloudflare R2**: オブジェクトストレージ（ツリーデータの保存）
- **ローカルストレージ**: 未認証ユーザーのデータ保存

### 認証・セキュリティ

- **OIDC**: OpenID Connect による認証
- **Google OAuth**: Google アカウントでのログイン

### その他の主要技術

- **pako**: データ圧縮ライブラリ
- **i18n**: 多言語対応（日本語・英語）

## アーキテクチャ

### 1. レイヤーアーキテクチャ

```
┌─────────────────────────────────────────────┐
│           プレゼンテーション層                 │
│    (React Components + Next.js Pages)       │
├─────────────────────────────────────────────┤
│              アプリケーション層                │
│        (カスタムフック・状態管理)               │
├─────────────────────────────────────────────┤
│                 API層                       │
│           (Hono APIハンドラー)                │
├─────────────────────────────────────────────┤
│              データアクセス層                  │
│         (Drizzle ORM + Storage)             │
├─────────────────────────────────────────────┤
│            インフラストラクチャ層               │
│    (Cloudflare Workers/D1/R2/KV)            │
└─────────────────────────────────────────────┘
```

### 2. ディレクトリ構造

```
tree-editor-next/
├── app/                      # Next.js App Router
│   ├── page.tsx             # メインページ
│   ├── share/[token]/       # 共有ページ
│   └── api/[[...hono]]/     # API エンドポイント
│       └── handlers/        # APIハンドラー
│           ├── auth/        # 認証関連
│           ├── trees/       # ツリーCRUD
│           └── shares/      # 共有機能
├── components/              # Reactコンポーネント
│   ├── ui/                 # 基本UIコンポーネント
│   └── tree-editor/        # ツリーエディタ機能
│       ├── core/           # コアコンポーネント
│       ├── features/       # 機能別コンポーネント
│       └── types/          # 型定義
├── db/                     # データベース関連
│   ├── schema/            # スキーマ定義
│   └── migrations/        # マイグレーション
├── lib/                   # ライブラリ・ユーティリティ
│   ├── api-client.ts      # APIクライアント
│   └── storage/           # ストレージ抽象化
├── utils/                 # ユーティリティ関数
│   └── i18n/             # 国際化
└── public/               # 静的ファイル
```

### 3. データフロー

```
ユーザー操作
    ↓
React Component
    ↓
カスタムフック (useSWR)
    ↓
API Client
    ↓
Hono API Handler
    ↓
認証ミドルウェア
    ↓
ビジネスロジック
    ↓
Storage Layer
    ├→ D1 (メタデータ)
    └→ R2 (ツリーデータ)
```

### 4. 主要コンポーネント

#### コアコンポーネント

- **TreeContainer**: ツリー全体のコンテナ
- **TreeNode**: 個別ノードの表示・編集
- **TreeHeader**: ツールバーとアクション

#### 機能コンポーネント

- **DragDropProvider**: ドラッグ&ドロップ機能
- **SearchPanel**: 多機能検索（基本/タイプ/フィールド）
- **WorkspaceManager**: ワークスペース切り替え
- **TreeManager**: ツリー作成・削除・切り替え
- **ShareDialog**: ツリー共有機能
- **ImportExportDialog**: データのインポート/エクスポート

### 5. データモデル

#### TreeNode

```typescript
interface TreeNode {
  id: string;
  name: string;
  children: TreeNode[];
  customFields?: Record<string, any>;
  nodeType?: string;
  icon?: string;
  thumbnail?: string;
}
```

#### NodeType

```typescript
interface NodeType {
  id: string;
  name: string;
  fieldDefinitions: FieldDefinition[];
  color?: string;
  icon?: string;
}
```

#### FieldDefinition

- text: テキストフィールド
- textarea: 長文テキスト
- link: URL リンク
- youtube: YouTube 動画
- image: 画像
- audio: 音声ファイル

### 6. ストレージ戦略

#### ローカルストレージ

- 未認証ユーザーのデータ
- ワークスペース情報
- 一時的な設定

#### クラウドストレージ (R2)

- 認証済みユーザーのツリーデータ
- 圧縮形式で保存（pako 使用）
- ユーザーごとのディレクトリ構造

#### データベース (D1)

- ユーザー情報
- ツリーメタデータ
- 共有情報

### 7. セキュリティ

- **認証**: Google OAuth 経由の OIDC 認証
- **認可**: ユーザーごとのデータ分離
- **セッション管理**: JWT トークンベース
- **データ保護**: 圧縮・暗号化されたストレージ

### 8. パフォーマンス最適化

- **エッジコンピューティング**: Cloudflare Workers による低レイテンシ
- **データ圧縮**: pako によるストレージ削減
- **キャッシング**: SWR による効率的なデータフェッチ
- **遅延読み込み**: 大規模ツリーの段階的レンダリング

### 9. 拡張性

- **プラグイン可能なフィールドタイプ**: 新しいフィールドタイプの追加が容易
- **カスタムノードタイプ**: 用途に応じたノードタイプの定義
- **API 設計**: RESTful な設計で外部連携が可能
- **国際化対応**: 新しい言語の追加が容易

## 今後の展望

- リアルタイムコラボレーション機能
- バージョン管理・ブランチ機能
- 高度な権限管理（読み取り専用、編集権限など）
- プラグインシステムの実装
- モバイルアプリケーション対応
