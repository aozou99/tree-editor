# TreeEditorアプリ MVPリリース設計ドキュメント

## 1. 現状の機能と追加機能の概要

### 現状の機能
- ノードの作成と編集機能
- ツリー構造でのノード管理
- カスタムフィールド編集
- アイコン設定
- ドラッグ＆ドロップでのノード移動

### 追加が必要な機能
1. ノードの公開機能
2. 公開されたノードの閲覧機能
3. 公開/非公開の切り替え機能
4. 閲覧権限の制御

## 2. 必要な画面と機能の詳細設計

### 2.1 ノード作成・編集画面（既存機能の拡張）

**追加する機能**
- 公開/非公開の切り替えスイッチ
- 公開設定オプション（公開範囲の選択）
- 共有用リンクの生成と表示

**UI変更点**
- ノード詳細モーダルに公開設定セクションを追加
- ワークスペース設定に公開デフォルトオプションを追加

### 2.2 ノード公開リスト画面（新規）

**主な機能**
- 自分が公開したノードの一覧表示
- 公開状態の管理（一覧から公開/非公開の切り替え）
- 閲覧数などの簡易統計情報の表示
- 共有リンクのコピー機能

**UI要素**
- 公開中ノードのグリッド/リスト表示
- 各ノードの簡易情報（タイトル、作成日、閲覧数など）
- クイックアクション（公開停止、リンクコピーなど）

### 2.3 公開ノード閲覧画面（新規）

**主な機能**
- 読み取り専用モードでのノード表示
- ツリー構造のナビゲーション（展開/折りたたみのみ可能）
- ノード詳細の表示（カスタムフィールドの閲覧）
- オプションの共有機能（SNSシェアなど）

**UI要素**
- 読み取り専用ツリービュー
- ノード詳細表示エリア
- 作成者情報と作成日表示
- 「自分のワークスペースにコピー」ボタン（オプション）

### 2.4 公開ノード検索/ディスカバリー画面（新規）

**主な機能**
- 公開されているノードの検索
- カテゴリーやタグによるフィルタリング
- 人気/新着順での表示切り替え
- プレビュー表示

**UI要素**
- 検索ボックスとフィルターオプション
- 検索結果のカード表示
- プレビューモーダル
- 「閲覧する」ボタン

## 3. データモデルの拡張

### 3.1 ノード/ツリーモデルの拡張
```typescript
// 公開設定を追加
interface PublishSettings {
  isPublished: boolean;        // 公開状態
  publishedAt?: string;        // 公開日時
  visibility: 'public' | 'unlisted' | 'private'; // 公開範囲
  accessCode?: string;         // オプションのアクセスコード（限定公開用）
  shareableLink?: string;      // 共有用リンク
  viewCount: number;           // 閲覧数
}

// ワークスペースモデルを拡張
interface Workspace {
  // 既存フィールド
  id: string;
  name: string;
  createdAt: string;
  updatedAt: string;
  tree: TreeNode[];
  nodeTypes: NodeType[];
  treeTitle: string;
  
  // 追加フィールド
  publishSettings?: PublishSettings;
  ownerId: string;             // 所有者ID
  collaborators?: string[];    // 共同編集者（オプション）
}
```

### 3.2 ユーザーモデル（新規）
```typescript
interface User {
  id: string;
  name: string;
  email: string;
  avatar?: string;
  publishedWorkspaces: string[]; // 公開中ワークスペースのID配列
}
```

## 4. API設計

### 4.1 公開管理API
- `POST /api/workspaces/:id/publish` - ワークスペースを公開する
- `POST /api/workspaces/:id/unpublish` - 公開を停止する
- `PUT /api/workspaces/:id/publish-settings` - 公開設定を更新する
- `GET /api/users/:id/published-workspaces` - ユーザーの公開ワークスペース一覧を取得

### 4.2 閲覧API
- `GET /api/public/workspaces/:id` - 公開ワークスペースを取得
- `GET /api/public/workspaces` - 公開ワークスペース一覧を取得
- `POST /api/public/workspaces/:id/view` - 閲覧数をインクリメント

### 4.3 検索API
- `GET /api/public/search` - 公開ワークスペースを検索
- `GET /api/public/categories/:id` - カテゴリ別公開ワークスペース取得

## 5. 認証・権限管理

### 5.1 認証機能
- メールアドレスによるサインアップ/ログイン
- OAuth認証（Google, GitHubなど）
- JWT/セッションベースの認証管理

### 5.2 権限レベル
- 所有者: すべての操作が可能
- 閲覧者: 閲覧のみ可能、編集不可
- 認証なし: 公開設定に応じたアクセス

## 6. 実装計画

### フェーズ1（基本公開機能）
1. ユーザー認証システムの実装
2. ノード詳細画面に公開/非公開切り替え機能追加
3. 公開ノード閲覧画面の実装
4. 共有リンク機能の実装

### フェーズ2（管理機能）
1. 公開ノード管理画面の実装
2. アクセス統計機能の追加
3. 公開設定の詳細オプション実装

### フェーズ3（発見性向上）
1. 公開ノード検索/ディスカバリー画面の実装
2. カテゴリ/タグシステムの実装
3. ソーシャル共有機能の強化

## 7. 技術スタック拡張

- **バックエンド**: Cloudflare Workers
- **データベース**: Cloudflare D1 (SQLiteベース)
- **オブジェクトストレージ**: Cloudflare R2
- **認証**: Cloudflare Access または Auth0
- **UI拡張**: 既存の shadcn/ui コンポーネント拡張

### 7.1 Cloudflareインフラストラクチャの詳細

#### Cloudflare Workersの活用
- サーバーレスでAPIエンドポイントを提供
- エッジでの実行により世界中で低レイテンシーを実現
- 自動スケーリングでトラフィック変動に対応

#### ストレージ戦略
- **ローカルストレージ**: 編集中のデータやオフラインでの作業用
- **Cloudflare R2**: 
  - ノードデータをJSONファイルとして保存
  - 画像やメディアファイルの保存
  - 公開ノードのアセット管理

#### データベース戦略
- **Cloudflare D1**:
  - ユーザー情報の管理
  - R2のオブジェクトURLとメタデータの管理
  - アクセス統計や閲覧数の集計
  - 検索インデックスの保存（タグ、カテゴリなど）

#### インフラストラクチャのメリット
- コスト効率の高いスケーリング
- 無料枠が比較的大きく、MVPフェーズに最適
- グローバルCDNによる高速配信
- 統合されたセキュリティ対策

#### 考慮事項
- Workersの実行時間制限（CPU時間50ms）への対応
- D1の機能制限を考慮したスキーマ設計
- コールドスタート対策

## 8. 考慮事項と課題

1. **パフォーマンス**
   - 大規模なツリーデータの効率的な読み込みと表示
   - API呼び出しの最適化

2. **セキュリティ**
   - 公開/非公開設定の確実な適用
   - XSS対策とユーザー入力サニタイズ

3. **UX設計**
   - 編集モードと閲覧モードの明確な区別
   - 直感的な公開設定インターフェース

### 8.4 クラウドアーキテクチャ
- Cloudflare Workersの実行時間制限に対する最適化
- R2のオブジェクト管理効率化（キャッシュ戦略）
- D1データベースの適切なスキーマ設計とインデックス
- マルチユーザー環境でのレート制限の実装

## 9. 次期開発ロードマップ（MVP以降）

- コラボレーション機能（複数ユーザーでのリアルタイム編集）
- コメント・フィードバックシステム
- テンプレート機能（公開ノードからテンプレート作成）
- 高度なアクセス解析
- Cloudflare Durableオブジェクトを活用したリアルタイム機能
- KV + D1を組み合わせたキャッシュ戦略の最適化